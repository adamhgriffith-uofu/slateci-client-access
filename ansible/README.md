# SLATE and Ansible

> **_IMPORTANT:_** This tool requires a read-through of [SLATE: Automated Cluster Installation](https://slateci.io/docs/cluster/automated/prerequisites.html) beforehand and if you have questions reach out to the team via SLACK, in an email, or during the working-sessions.

Ansible tools for use with SLATE cluster deployments.

## Requirements

> **_NOTE:_** This image requires `slateci-client-api:prod` (see the primary [README](/README.md)).

### Dockerfile Arguments

The `Dockerfile` provides the following build arguments:

| Name      | Required | Description                                                                                         |
|-----------|----------|-----------------------------------------------------------------------------------------------------|
| `venvdir` | No       | The directory for the virtual Python environment If not specified this will be set to `/root/venv`. |

## Build and Run

### Production

Build the Docker image while at the root of this repository:

```shell
docker build --file ansible/Dockerfile --tag ansiblepy:latest .
```

Running the image will create a new tagged container, print the connection information, and start up `/bin/bash`.

```shell
[your@localmachine ~]$ docker run -it -v /<repo-location>/submodules:/work ansiblepy:latest
======= Connection Information ========================================================================
Endpoint: <endpoint-url>

Name ID Email Phone
First Last user_xxxx your@email.com no phone

Client Version Server Version
1234           1234          
Server supported API versions: v1alpha3
=======================================================================================================
[root@1234 ~]$
```

* Use the `/<repo-location>/submodules:/work` volume to mount files from your local machine to the container.
* See [SSH Commands](/README.md#ssh-commands) for information on that topic.

## Create K8s Cluster

> **_NOTE:_** The following will use Fabric as an example.

As described in [SLATE: Automated Cluster Installation](https://slateci.io/docs/cluster/automated/prerequisites.html) we need some boilerplate Ansible to work with. Copy the example to a new location.

```shell
cp -rfp /work/kubespray/inventory/sample /work/kubespray/inventory/fabric
```

Overwrite the copied `/work/kubespray/inventory/fabric/hosts.yaml` file with one generated by you for FABRIC, Chameleon, CloudLab, etc. An example for FABRIC may be found at [hosts.j2](https://github.com/adamhgriffith-uofu/fabric-testbed-api/blob/main/ansible/hosts.j2).

Set the Kubernetes version for Kubespray and your cluster. SLATE does not support 1.22 right now so specify any older version.

```shell
sed -i 's/kube_version:.*/kube_version: v1.19.7/g' /work/kubespray/inventory/fabric/group_vars/k8s-cluster/k8s-cluster.yml
```

Add the nodes to `/root/.ssh/known_hosts` (this sometimes helps prevent Ansible SSH errors):

```shell
ssh-keyscan -H <node-ipv4> >> ~/.ssh/known_hosts
```

and so forth.

Create the cluster noting it may take several minutes to complete.

```shell
ansible-playbook -i /work/kubespray/inventory/fabric/hosts.yml --become --become-user=root -u centos /work/kubespray/cluster.yml
```
## Troubleshooting

### Full Reset

A.k.a the giant hammer. If something goes funky don't worry, you can reset the cluster with this command:

```shell
ansible-playbook -i /work/kubespray/inventory/fabric/hosts.yml --become --become-user=root -u centos /work/kubespray/reset.yml
```

Try running Ansible's commands again.

### SSH Errors

* Sometimes Ansible is going to fail on the SSH step.
* Verify you can independently `ssh` into each node.

Use the verbose mode for `ssh` to detect granular errors:

```shell
ssh -J fabric-bastion-host -i /root/.ssh/id_rsa_fabric_slice -vvv centos@<node-ip>
```

## Register K8s Cluster w/SLATE

Use the `slate-ansible` submodule to register the newly created K8s cluster with the SLATE API server.

```shell
ansible-playbook -i /work/kubespray/inventory/fabric/hosts.yml --become --become-user=root -u centos -e "slate_cli_token=$SLATE_CLI_TOKEN" -e "slate_cli_endpoint=$SLATE_CLI_ENDPOINT" /work/slate-ansible/site.yml
```